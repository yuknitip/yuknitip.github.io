<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Riwayat Pesanan</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    background: #fff8f0;
    color: #333;
    padding-bottom: 80px; /* agar tidak ketutupan bottom nav */
    overflow-x: hidden;
  }

  .bottom-nav {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 60px;
    background: #ffffff;
    border-top: 0px solid #ddd;
    display: flex;
    justify-content: space-evenly;
    align-items: center;
    z-index: 1000;
  }

  .bottom-nav .nav-item {
    text-decoration: none;
    color: #ff7b00;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bottom-nav .nav-item i {
    font-size: 20px;
  }

  @media (min-width: 768px) {
    .bottom-nav .nav-item {
      font-size: 14px;
    }

    .bottom-nav .nav-item i {
      font-size: 26px;
    }
  }

  main {
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
  }
</style>
</head>
<body>
  <header>
    <div class="logo-container">
    <a href="index.html"><img src="logonitip.png" alt="Nitip Logo" class="logo-img">
    </a>
    </div>
  </header>

  <main style="max-width: 600px; margin: 0 auto;">
    <div class="riwata-icon">
    <h2>Riwayat Nitip Makanan</h2>
    <div id="riwayat-container" class="riwayat-section"></div>

    <h2>Riwayat Nitip Barang</h2>
    <div id="daftarRiwayat" class="riwayat-section"></div>

    <h2>Riwayat Nitip Belanja</h2>
    <div id="daftarRiwayatBelanja" class="riwayat-section"></div>    

    <div style="text-align: center;" class="clearcart">
      <button onclick="clearOrderHistory()">Kosongkan Riwayat Pesanan</button>
    </div>
    </div>
  </main>

  <footer style="text-align: center; padding: 20px; background-color: #f7f7f7;">
  <p>&copy; 2025 Nitip. Karya Anak Tarempa. Semua Hak Dilindungi.</p>
</footer>
  
<div class="bottom-nav">
    <a href="index.html" class="nav-item">
      <i class="fas fa-home"></i>
      <span>Beranda</span>
    </a>
    <a href="riwayat.html" class="nav-item">
      <i class="fas fa-clock"></i>
      <span>Aktivitas</span>
    </a>
    <a href="about.html" class="nav-item">
      <i class="fas fa-info-circle"></i>
      <span>Tentang</span>
    </a>
  </div>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then((reg) => console.log("Service worker registered:", reg))
        .catch((err) => console.error("SW registration failed:", err));
    }

    let deferredPrompt;
    const installBtn = document.getElementById("installBtn");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = "block";
    });

    installBtn.addEventListener("click", async () => {
      installBtn.style.display = "none";
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === "accepted") {
          console.log("User accepted install");
        }
        deferredPrompt = null;
      }
    });

    window.addEventListener("appinstalled", () => {
      console.log("PWA installed");
      installBtn.style.display = "none";
    });

    if (window.matchMedia("(display-mode: standalone)").matches) {
      installBtn.style.display = "none";
    }
  </script>
  <script>
    function toggleNavMenu() {
        const nav = document.getElementById('mobile-nav');
        nav.style.display = nav.style.display === 'block' ? 'none' : 'block';
      }

    function clearOrderHistory() {
      if (!confirm("Yakin ingin menghapus semua riwayat pesanan?")) return;

      const confirmText = prompt("Ketik 'HAPUS' untuk konfirmasi akhir.");
      if (confirmText && confirmText.toUpperCase() === "HAPUS") {
        localStorage.removeItem("orderHistory");
        localStorage.removeItem("riwayatPengiriman");
        localStorage.removeItem("riwayatNitipBelanja");

        tampilkanRiwayat();
        tampilkanRiwayatBarang();
        tampilkanRiwayatBelanja();

        alert("Semua riwayat pesanan berhasil dihapus.");
      } else {
        alert("Penghapusan dibatalkan.");
      }
    }

    function tampilkanRiwayat() {
      const estimasiPerLokasi = {
        "Tarempa": 20, "Tarempa Barat": 25, "Sri Tanjung": 30,
        "Air Padang": 35, "Tanjung Momong": 35, "Telok Rit": 35,
        "Telok Buluh": 35, "Antang": 35, "Pasir Peti": 45,
        "Dusun": 45, "Telok Mabai": 45, "Selambak": 45,
        "Temburun": 50, "Batu Tambun": 25, "Gudang Tengah": 30,
        "Rintis": 30, "Air Bini": 50, "Arung Hijau": 40
      };

      const container = document.getElementById("riwayat-container");
      const data = JSON.parse(localStorage.getItem("orderHistory")) || [];
      container.innerHTML = "";

      if (data.length === 0) {
        container.innerHTML = "<p>Belum ada pesanan.</p>";
        return;
      }

      const grouped = {};
      data.reverse().forEach(p => {
        const key = new Date(p.waktu).toISOString().split("T")[0];
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(p);
      });

      Object.keys(grouped).forEach(key => {
        const tanggal = new Date(key).toLocaleDateString('id-ID', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        const section = document.createElement("section");
        section.innerHTML = `<h3>${tanggal}</h3>`;

        grouped[key].forEach(pesanan => {
          const waktu = new Date(pesanan.waktu);
          const estimasi = estimasiPerLokasi[pesanan.lokasi.trim()] || 40;
          const tiba = new Date(waktu.getTime() + estimasi * 60000);

          // Cek apakah sudah lebih dari 10 menit
      const sekarang = new Date();
      const selisihMenit = (sekarang - waktu) / 60000;
      const showHubungiAdmin = selisihMenit >= 1;

          const div = document.createElement("div");
          div.className = "riwayat-item";
          div.innerHTML = `
            <p><strong>Nama:</strong> ${pesanan.nama}</p>
            <p><strong>Alamat:</strong> ${pesanan.alamat}</p>
            <p><strong>Lokasi:</strong> ${pesanan.lokasi}</p>
            <p><strong>Total:</strong> Rp${pesanan.total.toLocaleString("id-ID")}</p>
            <p><strong>Metode:</strong> ${pesanan.pembayaran}</p>
            <p><strong>Waktu Pesan:</strong> ${waktu.toLocaleString("id-ID")}</p>
            <p><strong>Estimasi Tiba:</strong> ${tiba.toLocaleTimeString("id-ID", { hour: '2-digit', minute: '2-digit' })}</p>
            <ul>${pesanan.items.map(i => `<li>${i.qty}x ${i.name} ${i.price} (${i.merchant})</li>`).join("")}</ul>
           ${showHubungiAdmin ? `
          <div style="margin-top:10px;">
            <a href="https://wa.me/6281261319225?text=Halo%20Admin,%20saya%20(${encodeURIComponent(pesanan.nama)})%20sudah%20checkout%20pada%20${encodeURIComponent(waktu.toLocaleString("id-ID"))}%20tapi%20belum%20ada%20respon."
               target="_blank" class="btn-wa-admin">
              ðŸ“ž Chat Admin
            </a>
          </div>
        ` : ""}
            `;
          section.appendChild(div);
        });

        container.appendChild(section);
      });
    }

    function tampilkanRiwayatBarang() {
      const container = document.getElementById("daftarRiwayat");
      const riwayat = JSON.parse(localStorage.getItem("riwayatPengiriman")) || [];

      if (riwayat.length === 0) {
        container.innerHTML = "<p>Belum ada pengiriman barang.</p>";
        return;
      }

      container.innerHTML = riwayat.map(item => `
        <div class="riwayat-item">
          <p><strong>Waktu:</strong> ${item.waktu}</p>
          <p><strong>Pengirim:</strong> ${item.namaPengirim} (${item.noPengirim})</p>
          <p><strong>Penerima:</strong> ${item.namaPenerima} (${item.noPenerima})</p>
          <p><strong>Alamat Tujuan:</strong> ${item.alamatPenerima}</p>
          <p><strong>Barang:</strong> ${item.deskripsiBarang}</p>
          <p><strong>Ongkir:</strong> ${item.ongkirText}</p>
        </div>
      `).join("");
    }

    function tampilkanRiwayatBelanja() {
      const container = document.getElementById("daftarRiwayatBelanja");
      const riwayat = JSON.parse(localStorage.getItem("riwayatNitipBelanja")) || [];

      if (riwayat.length === 0) {
        container.innerHTML = "<p>Belum ada riwayat nitip belanja.</p>";
        return;
      }

      container.innerHTML = riwayat.map(item => `
        <div class="riwayat-item">
          <p><strong>Waktu:</strong> ${item.waktu}</p>
          <p><strong>Tempat Belanja:</strong> ${item.tempatBelanja}</p>
          <p><strong>Deskripsi Barang:</strong> ${item.deskripsiBarang}</p>
          <p><strong>Nama Pembeli:</strong> ${item.namaPembeli} (${item.nomor})</p>
          <p><strong>Alamat:</strong> ${item.alamatPembeli}</p>
          <p><strong>Ongkir:</strong> ${item.ongkirText}</p>
        </div>
      `).join("");
    }

    document.addEventListener("DOMContentLoaded", () => {
      tampilkanRiwayat();
      tampilkanRiwayatBarang();
      tampilkanRiwayatBelanja();
    });
  </script>
</body>
</html>
